@startuml
' ==== AGREGADOR SIN CONTROLLERS ====
package Agregador {

class Coleccion {
  - id : String
  - hechos : List<Hecho>
  - algoritmo : IAlgoritmoConsenso
  - titulo : String
  - descripcion : String
  - criteriosDePertenencia : List<ICriterioDePertenencia>
  - fuentes : List<FuenteNombre>

  + agregarHecho(hecho : Hecho) : void
  + actualizarHechos(hechos : List<Hecho>) : void
  + getHechos() : List<Hecho>
  + getHechosFiltradosPorConsenso() : List<Hecho>
  + agregarHechos(hechos : List<Hecho>) : void
}

class Hecho {
  - id : String
  - consensoNivel : ConsensoNivel = ConsensoNivel.NINGUNO
  - descripcion : String
  - titulo : String
  - categoria : Categoria
  - ubicacion : Ubicacion
  - fecha : LocalDate
  - fechaDeCarga : LocalDate
  - multimediaArchivo : byte[]
  - multimediaNombre : String
  - origen : Origen
  - etiquetas : List<String>
  - eliminado : boolean
  - fuentes : Set<FuenteNombre>

  + agregarEtiqueta(etiqueta : String) : void
  + getEtiquetas() : List<String>
  + marcarComoEliminado() : void
  + puedeAgregarseAColeccion() : boolean
  + agregarFuente(fuente : FuenteNombre) : void
  + agregarFuentes(nuevasFuentes : Set<FuenteNombre>) : void
  + getFuentes() : Set<FuenteNombre>
}

class ColeccionDTO {
  - id : String
  - titulo : String
  - descripcion : String
  - hechos : List<HechoDTO>
}

class HechoDTO {
  - id : String
  - titulo : String
  - descripcion : String
  - categoria : String
  - latitud : double
  - longitud : double
  - fecha_hecho : LocalDateTime
  - created_at : LocalDateTime
  - updated_at : LocalDateTime
  - archivoContenido : byte[]
  - archivoNombre : String
}

class ColeccionMapper {
  + toDTO(coleccion : Coleccion) : ColeccionDTO
}

class HechoMapper {
  + aDTO(hecho : Hecho) : HechoDTO
  + aDominio(dto : HechoDTO) : Hecho
}

class SolicitudEliminacion {
  - id : Long
  - fechaCreacion : LocalDateTime
  - estado : EstadoSolicitud
  - hecho : Hecho
  - motivo : String

  + SolicitudEliminacion(hecho : Hecho, motivo : String)
  + aceptar() : void
  + rechazar() : void
}

class SolicitudDTO {
  - fechaCreacion : LocalDateTime
  - estado : String
  - hecho : String
  - motivo : String
}

class ColeccionRepository {
  - colecciones : Map<String, Coleccion>
  - idGenerator : AtomicLong

  + save(coleccion : Coleccion) : String
  + saveAll(coleccionesNuevas : List<Coleccion>) : List<String>
  + findById(id : String) : Optional<Coleccion>
  + findAll() : List<Coleccion>
  + existsById(id : String) : boolean
  + delete(id : String) : void
  + deleteAll() : void
  + count() : long
  + update(id : String, nuevaColeccion : Coleccion) : void
}

class HechoRepository {
  - hechosPorClave : Map<String, Hecho>
  - idGenerator : AtomicLong

  + save(hecho : Hecho) : String
  + saveAll(hechosLista : List<Hecho>) : List<String>
  + findById(id : String) : Optional<Hecho>
  + findAll() : List<Hecho>
  + delete(id : String) : void
  + clear() : void
  + findIgual(hecho : Hecho) : Optional<Hecho>
}

class SolicitudRepository {
  - solicitudes : List<SolicitudEliminacion>

  + save(solicitud : SolicitudEliminacion) : void
  + findAll() : List<SolicitudEliminacion>
  + findByFact(hecho : Hecho) : Optional<SolicitudEliminacion>
  + findById(id : Long) : Optional<SolicitudEliminacion>
  + delete(solicitud : SolicitudEliminacion) : void
}

class ConsensoScheduler {
  - consensoService : ConsensoService
  + ejecutarConsensoProgramado() : void
}

class FuenteScheduler {
  - coleccionService : ColeccionService
  - agregadorService : AgregadorService
  + actualizarColecciones() : void
}

class AgregadorService {
  - restTemplate : RestTemplate
  - hechoRepo : HechoRepository
  - coleccionRepo : ColeccionRepository
  - fuenteProvider : FuenteProvider

  + cargarHechosYAsignar() : void
}

class ColeccionService {
  - coleccionRepository : ColeccionRepository
  - hechoRepository : HechoRepository

  + crearColeccion(titulo : String, descripcion : String) : void
  + obtenerColecciones() : List<Coleccion>
  + obtenerColeccionPorId(id : String) : Optional<Coleccion>
  + obtenerHechosPorColeccion(idColeccion : String) : List<Hecho>
  + obtenerHechosIrrestricto(id : String) : List<Hecho>
  + obtenerHechosCurado(id : String) : List<Hecho>
  + actualizarColecciones() : void
  + actualizarColeccion(id : String, nuevoTitulo : String, nuevaDescripcion : String) : void
  + agregarHechos(hechosDTO : List<HechoDTO>) : void
  + eliminarColeccion(id : String) : void
  + eliminarTodos() : void
}

class ConsensoService {
  - coleccionRepo : ColeccionRepository
  - fuenteConfig : FuenteConfig
  + aplicarConsensoPorColeccion() : void
}

class FuenteProvider {
  - urls : Map<FuenteNombre, String>
  + getUrl(fuente : FuenteNombre) : String
  + getTodasLasFuentes() : Set<FuenteNombre>
}

class SolicitudService {
  - solicitudRepository : SolicitudRepository
  - spamDetector : ISpamDetector
  + crearSolicitud(solicitud : SolicitudEliminacion) : SolicitudEliminacion
  + procesarSolicitud(id : Long, accion : String) : SolicitudEliminacion
}

interface ISpamDetector {
  + esSpam(message : String) : boolean
}

class SpamDetector {
  - vaguePhrases : List<String>
  - emotionalWords : List<String>
  + esSpam(message : String) : boolean
}

interface ICriterioDePertenencia {
  + cumple(hecho : Hecho) : boolean
}

class CriterioFiltroTitulo {
  - texto : String
  + cumple(hecho : Hecho) : boolean
}

class CriterioPorCategoria {
  - categoria : Categoria
  + cumple(hecho : Hecho) : boolean
}

class CriterioPorFecha {
  - desde : LocalDate
  - hasta : LocalDate
  + cumple(hecho : Hecho) : boolean
}

class CriterioPorUbicacion {
  - ubicacion : Ubicacion
  + cumple(hecho : Hecho) : boolean
}

interface IAlgoritmoConsenso {
  + aplicar(hecho : Hecho, totalFuentes : int) : ConsensoNivel
  + getNivelQueAplica() : ConsensoNivel
}

class AlgoritmoMayoriaSimple {
  + aplicar(hecho : Hecho, totalFuentes : int) : ConsensoNivel
  + getNivelQueAplica() : ConsensoNivel
}

class AlgoritmoMayoriaAbsoluta {
  + aplicar(hecho : Hecho, totalFuentes : int) : ConsensoNivel
  + getNivelQueAplica() : ConsensoNivel
}

enum ConsensoNivel {
  NINGUNO
  MULTIPLES_MENCIONES
  MAYORIA_SIMPLE
  MAYORIA_ABSOLUTA
}

enum EstadoSolicitud {
  ACEPTADA
  RECHAZADA
  PENDIENTE
}

enum FuenteNombre {
  ESTATICA
  DINAMICA
  PROXY
}

enum Origen {
  CARGA_MANUAL
  DATASET
  CONTRIBUYENTE
  API
}

class Categoria {
  - nombre : String
  + getNombre() : String
}

class Ubicacion {
  - latitud : Double
  - longitud : Double
  + getLatitud() : Double
  + getLongitud() : Double
}

Coleccion --> "*" ICriterioDePertenencia : criteriosDePertenencia
Coleccion --> "*" FuenteNombre : fuentes
Coleccion --> "*" Hecho : hechos
Coleccion --> IAlgoritmoConsenso : algoritmo
Hecho --> Categoria
Hecho --> Ubicacion
SolicitudEliminacion --> Hecho
HechoMapper --> Hecho
HechoMapper --> HechoDTO
ColeccionMapper --> Coleccion
ColeccionMapper --> ColeccionDTO
SpamDetector ..|> ISpamDetector
CriterioFiltroTitulo ..|> ICriterioDePertenencia
CriterioPorCategoria ..|> ICriterioDePertenencia
CriterioPorFecha ..|> ICriterioDePertenencia
CriterioPorUbicacion ..|> ICriterioDePertenencia
AlgoritmoMayoriaSimple ..|> IAlgoritmoConsenso
AlgoritmoMayoriaAbsoluta ..|> IAlgoritmoConsenso

}
@enduml
