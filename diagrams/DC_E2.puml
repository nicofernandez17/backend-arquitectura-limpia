@startuml

' Configuración básica
skinparam packageStyle rectangle
skinparam linetype ortho
left to right direction


' === COMPONENTE AGREGADOR ===
package "components.agregador" {
  package "utn.models.domain" {
    class Hecho {
      - String id
      - String contenido
      - Boolean eliminado
      - String fuente
      - LocalDateTime fechaCreacion
      + marcarComoEliminado()
      + getContenido(): String
      + getFuente(): String
      + isEliminado(): Boolean
    }

    class Coleccion {
      - String id
      - String nombre
      - String descripcion
      - List<Hecho> hechos
      - LocalDateTime fechaActualizacion
      + actualizarHechos()
      + getHechos(): List<Hecho>
      + agregarHecho(hecho: Hecho)
      + eliminarHecho(id: String)
      + getNombre(): String
    }

    class SolicitudEliminacion {
      - LocalDateTime fechaCreacion
      - EstadoSolicitud estado
      - Hecho hecho
      - String motivo
      + SolicitudEliminacion(hecho: Hecho, motivo: String)
      + aceptar()
      + rechazar()
      + getHecho(): Hecho
      + getMotivo(): String
    }

    enum EstadoSolicitud {
      PENDIENTE
      ACEPTADA
      RECHAZADA
    }

    SolicitudEliminacion --> EstadoSolicitud
    SolicitudEliminacion --> Hecho
    Coleccion --> "*" Hecho: contiene
  }

  package "utn.models.dto" {
    class SolicitudDto {
      - String hechoId
      - String motivo
    }

    class ColeccionDto {
      - String nombre
      - String descripcion
    }

    class HechoMapper {
      + {static} aDominio(hechoExterno: Object): Hecho
      + {static} aDto(hecho: Hecho): HechoDto
    }
  }

  package "utn.repositories" {
    interface SolicitudRepository {
      + save(solicitud: SolicitudEliminacion): SolicitudEliminacion
      + findByEstado(estado: EstadoSolicitud): List<SolicitudEliminacion>
      + findById(id: Long): Optional<SolicitudEliminacion>
    }

    interface ColeccionRepository {
      + findAll(): List<Coleccion>
      + findById(id: String): Optional<Coleccion>
      + save(coleccion: Coleccion): Coleccion
      + deleteById(id: String): void
    }

    interface HechoRepository {
      + findAll(): List<Hecho>
      + findById(id: String): Optional<Hecho>
      + save(hecho: Hecho): Hecho
      + deleteById(id: String): void
    }
  }

  package "utn.services" {
    class ColeccionService {
      - ColeccionRepository coleccionRepository
      + actualizarHechosDeTodasLasColecciones()
      + obtenerColecciones(): List<Coleccion>
      + obtenerHechosPorColeccion(id: String): List<Hecho>
      + crearColeccion(coleccion: Coleccion): Coleccion
      + eliminarColeccion(id: String): void
    }
    ' === INTERFACES BASE ===


    class SolicitudService {
      - SolicitudRepository solicitudRepository
      - ISpamDetector spamDetector
      + crearSolicitud(solicitud: SolicitudEliminacion): SolicitudEliminacion
      + getSolicitudesPendientes(): List<SolicitudEliminacion>
      + aceptarSolicitud(id: Long): SolicitudEliminacion
      + rechazarSolicitud(id: Long): SolicitudEliminacion
    }

    package "utn.services.fuentes" {
      ' Adaptadores para las fuentes externas
      class FuenteDinamicaService implements IFuenteService {
        - FuenteDinamica fuenteDinamica
        + obtenerHechos(): List<Hecho>
        + actualizarFuente(): void
        + getNombre(): String
      }

      class FuenteEstaticaService implements IFuenteService {
        - FuenteEstatica fuenteEstatica
        + obtenerHechos(): List<Hecho>
        + actualizarFuente(): void
        + getNombre(): String
      }

      class FuenteProxyService implements IFuenteService {
        - FuenteProxy fuenteProxy
        + obtenerHechos(): List<Hecho>
        + actualizarFuente(): void
        + getNombre(): String
      }

      class FuenteMetamapaService implements IFuenteService {
        - FuenteMetamapa fuenteMetamapa
        + obtenerHechos(): List<Hecho>
        + actualizarFuente(): void
        + getNombre(): String
      }
      interface IFuenteService {
            + obtenerHechos(): List<Hecho>
            + actualizarFuente(): void
            + getNombre(): String
          }
    }

    package "utn.services.spamDetector" {
      class SimpleSpamDetector implements ISpamDetector {
        - List<String> palabrasProhibidas
        + esSpam(motivo: String): boolean
      }
      interface ISpamDetector {
            + esSpam(motivo: String): boolean
          }

      class AdvancedSpamDetector implements ISpamDetector {
        - double umbralConfianza
        + esSpam(motivo: String): boolean
        - analizarTexto(texto: String): double
      }
    }
  }

  package "utn.controllers" {
    class SolicitudController {
      - SolicitudService solicitudService
      + crearSolicitud(solicitudDto: SolicitudDto): ResponseEntity
      + getSolicitudesPendientes(): ResponseEntity
      + aceptarSolicitud(id: Long): ResponseEntity
      + rechazarSolicitud(id: Long): ResponseEntity
    }

    class ColeccionController {
      - ColeccionService coleccionService
      + getColecciones(): ResponseEntity
      + getHechosPorColeccion(id: String): ResponseEntity
      + crearColeccion(coleccionDto: ColeccionDto): ResponseEntity
      + eliminarColeccion(id: String): ResponseEntity
    }
  }

  package "utn.config" {
    class AgregadorConfig {
      + spamDetector(): ISpamDetector
    }
  }

  ' Relaciones internas del agregador
  ColeccionService --> ColeccionRepository
  ColeccionService --> Hecho
  ColeccionService --> Coleccion

  SolicitudService --> SolicitudRepository
  SolicitudService --> ISpamDetector
  SolicitudService --> SolicitudEliminacion

  ColeccionController --> ColeccionService
  ColeccionController --> ColeccionDto

  SolicitudController --> SolicitudService
  SolicitudController --> SolicitudDto

  AgregadorConfig --> SimpleSpamDetector
}

' === COMPONENTE APP-MAIN ===
package "components.app-main" {
  package "utn.appmain.services" {
    class MainService {
      + getStatus(): String
      + getWelcomeMessage(): String
      + getHealthStatus(): Map<String, Object>
      + getMetrics(): Map<String, Object>
    }

    class UsuarioService {
      - UsuarioRepository usuarioRepository
      + getUsuarios(): List<Usuario>
      + getUsuarioById(id: String): Optional<Usuario>
      + crearUsuario(usuario: Usuario): Usuario
      + actualizarUsuario(id: String, usuario: Usuario): Usuario
      + eliminarUsuario(id: String): void
    }
  }

  package "utn.appmain.controllers" {
    class MainController {
      - MainService mainService
      + home(): String
      + status(): String
      + health(): ResponseEntity<Map<String, Object>>
      + metrics(): ResponseEntity<Map<String, Object>>
    }

    class UsuarioController {
      - UsuarioService usuarioService
      + getUsuarios(): ResponseEntity<List<Usuario>>
      + getUsuarioById(id: String): ResponseEntity<Usuario>
      + crearUsuario(usuario: Usuario): ResponseEntity<Usuario>
      + actualizarUsuario(id: String, usuario: Usuario): ResponseEntity<Usuario>
      + eliminarUsuario(id: String): ResponseEntity<Void>
    }

    class FuentesController {
      - ColeccionService coleccionService
      - List<IFuenteService> fuentesServices
      + obtenerTodasLasFuentes(): ResponseEntity<Map<String, List<?>>>
      + actualizarTodasLasFuentes(): ResponseEntity<String>
    }
  }

  package "models" {
    class Usuario {
      - String id
      - String nombre
      - String email
      - LocalDateTime fechaCreacion
      - boolean activo
      + getId(): String
      + getNombre(): String
      + getEmail(): String
    }

    class SistemaMetricas {
      - int solicitudesProcesadas
      - int hechosTotales
      - int coleccionesTotales
      - Map<String, Integer> estadisticasPorFuente
      + getMetricas(): Map<String, Object>
    }
  }

  package "repositories" {
    interface UsuarioRepository {
      + findAll(): List<Usuario>
      + findById(id: String): Optional<Usuario>
      + save(usuario: Usuario): Usuario
      + deleteById(id: String): void
    }
  }

  ' Relaciones internas de app-main
  MainController --> MainService
  MainService --> SistemaMetricas

  UsuarioController --> UsuarioService
  UsuarioService --> UsuarioRepository
  UsuarioService --> Usuario

  FuentesController --> "components.agregador.utn.services.ColeccionService"
  FuentesController --> IFuenteService
}

' === COMPONENTE FUENTE-DINAMICA ===
package "components.fuente-dinamica" {
  package "services" {
    class FuenteDinamica {
      - ApiClient apiClient
      - FuenteDinamicaAdapter adapter
      + obtenerDatos(): List<Hecho>
      + conectar(): void
      + desconectar(): void
    }

    class ApiClient {
      - String baseUrl
      - HttpClient httpClient
      + obtenerDatos(): List<DatoDinamico>
      + establecerConexion(): void
    }

    class FuenteDinamicaAdapter {
      + adaptar(dato: DatoDinamico): Hecho
      - normalizarContenido(contenido: String): String
    }
  }

  package "models" {
    class DatoDinamico {
      - String id
      - String contenido
      - String categoria
      - LocalDateTime timestamp
      + getId(): String
      + getContenido(): String
    }
  }

  ' Relaciones internas de fuente-dinamica
  FuenteDinamica --> ApiClient
  FuenteDinamica --> FuenteDinamicaAdapter
  FuenteDinamica --> DatoDinamico
  FuenteDinamica ..> "components.agregador.utn.models.domain.Hecho": produce
  FuenteDinamicaAdapter ..> "components.agregador.utn.models.domain.Hecho": produce
}

' === COMPONENTE FUENTE-ESTATICA ===
package "components.fuente-estatica" {
  package "services" {
    class FuenteEstatica {
      - FileReader fileReader
      - FuenteEstaticaAdapter adapter
      + obtenerDatos(): List<Hecho>
      + cargarArchivo(path: String): void
    }

    class FileReader {
      - String filePath
      + leerArchivo(): List<DatoEstatico>
      + existeArchivo(): boolean
    }

    class FuenteEstaticaAdapter {
      + adaptar(dato: DatoEstatico): Hecho
      - formatearFecha(fechaStr: String): LocalDateTime
    }
  }

  package "models" {
    class DatoEstatico {
      - String id
      - String contenido
      - String fuente
      - String fechaStr
      + getId(): String
      + getContenido(): String
    }
  }

  ' Relaciones internas de fuente-estatica
  FuenteEstatica --> FileReader
  FuenteEstatica --> FuenteEstaticaAdapter
  FuenteEstatica --> DatoEstatico
  FuenteEstatica ..> "components.agregador.utn.models.domain.Hecho": produce
  FuenteEstaticaAdapter ..> "components.agregador.utn.models.domain.Hecho": produce
}

' === COMPONENTE FUENTE-PROXY ===
package "components.fuente-proxy" {
  package "services" {
    class FuenteProxy {
      - List<IFuenteExterna> fuentesExternas
      - ProxyAdapter adapter
      + obtenerDatos(): List<Hecho>
      + agregarFuente(fuente: IFuenteExterna): void
      + eliminarFuente(id: String): void
    }

    interface IFuenteExterna {
      + obtenerDatos(): List<DatoProxy>
      + getId(): String
    }

    class FuenteExternaImpl implements IFuenteExterna {
      - String id
      - String url
      - RestTemplate restTemplate
      + obtenerDatos(): List<DatoProxy>
      + getId(): String
    }

    class ProxyAdapter {
      + adaptar(dato: DatoProxy): Hecho
      - eliminarDuplicados(hechos: List<Hecho>): List<Hecho>
    }
  }

  package "models" {
    class DatoProxy {
      - String id
      - String contenido
      - String fuenteOriginal
      - LocalDateTime fecha
      + getId(): String
      + getContenido(): String
    }
  }

  ' Relaciones internas de fuente-proxy
  FuenteProxy --> IFuenteExterna
  FuenteProxy --> ProxyAdapter
  FuenteProxy --> DatoProxy
  FuenteProxy ..> "components.agregador.utn.models.domain.Hecho": produce
  ProxyAdapter ..> "components.agregador.utn.models.domain.Hecho": produce
}

' === COMPONENTE FUENTE-METAMAPA ===
package "components.fuente-metamapa" {
  package "services" {
    class FuenteMetamapa {
      - RepositorioMetamapa repositorio
      - MetamapaAdapter adapter
      + obtenerDatos(): List<Hecho>
      + sincronizar(): boolean
    }

    class RepositorioMetamapa {
      - String endpointUrl
      - MetamapaClient client
      + obtenerDatos(): List<DatoMetamapa>
      + actualizarRepositorio(): void
    }

    class MetamapaClient {
      - String apiKey
      - RestTemplate restTemplate
      + conectar(): boolean
      + obtenerDatos(): List<DatoMetamapa>
    }

    class MetamapaAdapter {
      + adaptar(dato: DatoMetamapa): Hecho
      - enriquecerMetadatos(hecho: Hecho): Hecho
    }
  }

  package "models" {
    class DatoMetamapa {
      - String id
      - String contenido
      - Map<String, Object> metadatos
      - double relevancia
      - LocalDateTime fecha
      + getId(): String
      + getContenido(): String
    }
  }

  ' Relaciones internas de fuente-metamapa
  FuenteMetamapa --> RepositorioMetamapa
  FuenteMetamapa --> MetamapaAdapter
  FuenteMetamapa --> DatoMetamapa
  FuenteMetamapa ..> "components.agregador.utn.models.domain.Hecho": produce
  MetamapaAdapter ..> "components.agregador.utn.models.domain.Hecho": produce
  RepositorioMetamapa --> MetamapaClient
}

' === RELACIONES ENTRE COMPONENTES ===
' Conexiones entre servicios de adaptadores y fuentes concretas
"components.agregador.utn.services.fuentes.FuenteDinamicaService" --> "components.fuente-dinamica.utn.services.FuenteDinamica": usa
"components.agregador.utn.services.fuentes.FuenteEstaticaService" --> "components.fuente-estatica.utn.services.FuenteEstatica": usa
"components.agregador.utn.services.fuentes.FuenteProxyService" --> "components.fuente-proxy.utn.services.FuenteProxy": usa
"components.agregador.utn.services.fuentes.FuenteMetamapaService" --> "components.fuente-metamapa.utn.services.FuenteMetamapa": usa

' Controlador principal usando servicios del agregador
"components.app-main.utn.appmain.controllers.FuentesController" --> "components.agregador.utn.services.ColeccionService": usa

@enduml